# ansible/01-pki/tasks/102-ca-etcd.yml
---
- name: Verificar arquivos existentes da CA do Etcd
  ansible.builtin.stat:
    path: "{{ arquivo }}"
  loop:
    - "{{ pki_cas.etcd.path_chave }}"
    - "{{ pki_cas.etcd.path_cert }}"
  loop_control:
    loop_var: arquivo
    label: "{{ arquivo | relpath(playbook_dir) }}"
  register: ca_etcd_arquivos
  delegate_to: localhost

- name: Criar chave privada da CA do Etcd
  community.crypto.openssl_privatekey:
    path: "{{ pki_cas.etcd.path_chave }}"
    type: "{{ pki_cifra_tipo }}"
    curve: "{{ pki_cifra_algo }}"
    state: "present"
    force: true
  when: not ca_etcd_arquivos.results[0].stat.exists or (pki_regerar_certs | default(false) | bool)
  delegate_to: localhost

- name: Gerar CSR da CA do Etcd
  community.crypto.openssl_csr_pipe:
    privatekey_path: "{{ pki_cas.etcd.path_chave }}"
    digest: "{{ pki_algoritmo_hash }}"
    subject:
      CN: etcd-ca
    use_common_name_for_san: false
    basic_constraints:
      - "CA:TRUE"
      - "pathlen:0"
    basic_constraints_critical: true
    key_usage:
      - keyCertSign
      - cRLSign
    key_usage_critical: true
  when: not ca_etcd_arquivos.results[1].stat.exists or (pki_regerar_certs | default(false) | bool)
  delegate_to: localhost
  register: ca_etcd_csr

- name: Assinar certificado do CA do Etcd com o Root CA
  community.crypto.x509_certificate:
    path: "{{ pki_cas.etcd.path_cert }}"
    csr_content: "{{ ca_etcd_csr.csr }}"
    provider: ownca
    ownca_path: "{{ pki_cas.etcd.ca_pai.path_cert }}"
    ownca_privatekey_path: "{{ pki_cas.etcd.ca_pai.path_chave }}"
    ownca_digest: "{{ pki_algoritmo_hash }}"
    ownca_not_after: "+{{ pki_validade.intermediario | default(365) }}d"
    mode: "0644"
    force: true
  when: not ca_etcd_arquivos.results[1].stat.exists or (pki_regerar_certs | default(false) | bool)
  delegate_to: localhost
