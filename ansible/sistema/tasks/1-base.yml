# ansible/sistema/tasks/1-base.yml
---
- name: Atualizar cache do dnf
  become: true
  ansible.builtin.dnf:
    update_cache: true

- name: Instalar pacotes extras necessários
  become: true
  ansible.builtin.dnf:
    name: "{{ pacotes_extras }}"
    state: present

- name: Atualizar todos os pacotes
  become: true
  ansible.builtin.dnf:
    name: "*"
    state: latest
  when: atualiza_sistema == "all"

- name: Atualizar apenas pacotes de segurança
  become: true
  ansible.builtin.dnf:
    name: "*"
    security: true
    state: latest
  when: atualiza_sistema == "patch"

- name: Verificar se precisa reiniciar
  ansible.builtin.command: needs-restarting -r
  register: reboot_check
  ignore_errors: true
  changed_when: reboot_check.rc == 1

- name: Reiniciar se necessário
  ansible.builtin.reboot:
  when: reboot_check.rc == 1

- name: Configurar o TZ para o especificado em defaults
  community.general.timezone:
    name: "{{ timezone_tz }}"

- name: Configurar locale do sistema para o especificado em defaults
  ansible.builtin.ini_file:
    path: /etc/locale.conf
    section: null
    option: LANG
    value: "{{ locale_lang }}"
    create: yes

- name: Gerar arquivo /etc/hosts para cada nó do cluster
  ansible.builtin.template:
    src: "hosts.j2"
    dest: "/etc/hosts"
    owner: "root"
    group: "root"
    mode: "0644"

- name: Colocar SELinux em modo permissivo
  become: true
  ansible.posix.selinux:
    policy: targeted
    state: permissive

- name: Instalar última versão do Tailspin para facilitar a leitura de logs
  ansible.builtin.unarchive:
    src: "https://github.com/bensadeh/tailspin/releases/latest/download/tailspin-aarch64-unknown-linux-musl.tar.gz"
    dest: "/usr/local/bin"
    remote_src: true
    mode: "0755"
    creates: "/usr/local/bin/tspin"

- name: Garantir a existência da pasta de temporários
  ansible.builtin.file:
    path: /vagrant/arquivos/tmp
    state: directory
    mode: '0755'
