# ansible/13-configuracoes-cluster/tasks/06-dashboard.yml
---
- name: Verificar releases instaladas no Helm
  ansible.builtin.command:
    cmd: "helm list -Aq"
  register: helm_releases
  failed_when: false
  changed_when: false

- name: Instalar o Kubernetes Dashboard se não estiver instalado
  when: not (helm_releases.stdout | regex_search('^ingress-nginx$', multiline=True))
  block:
    - name: Adicionar repositório helm do Kubernetes Dashboard
      ansible.builtin.command:
        cmd: "helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/"
      changed_when: true

    - name: Atualizar repositórios helm
      ansible.builtin.command:
        cmd: "helm repo update"
      changed_when: false

    - name: Garantir diretório charts na home do usuário do ansible
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/charts"
        state: directory
        mode: "0755"

    - name: Criar arquivo de configuração Helm para o Kubernetes Dashboard
      ansible.builtin.template:
        src: dashboard-helm-config.yml.j2
        dest: "/home/{{ ansible_user }}/charts/dashboard-helm-config.yml"
        mode: "0644"

    - name: Instalar chart do Kubernetes Dashboard
      ansible.builtin.command:
        cmd: >
          helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
          --namespace kubernetes-dashboard
          --create-namespace
          --values /home/{{ ansible_user }}/charts/dashboard-helm-config.yml
      changed_when: true

    - name: Criar arquivo manifest para implantação do Service Account no cluster
      ansible.builtin.template:
        src: dashboard-admin.yml.j2
        dest: "/home/{{ ansible_user }}/charts/dashboard-admin.yml"
        mode: "0644"

    - name: Criar Service Account dashboard-admin para acessar o dashboard
      ansible.builtin.command:
        cmd: "kubectl apply -f /home/{{ ansible_user }}/charts/dashboard-admin.yml"
      register: resultado_label
      changed_when: "'created' in resultado_label.stdout"