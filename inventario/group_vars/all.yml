# inventario/group_vars/all.yml
---
# Caminho absoluto para a pasta de artefatos
pasta_artefatos: "{{ playbook_dir }}/../artefatos"

# Pasta onde ficam os artefatos dos certificados
pasta_temporarios: "{{ pasta_artefatos }}/tmp"

# Versões dos componentes
versao_haproxy: "3.0"
versao_etcd: "3.5.14"
versao_kubernetes: "v1.31.2" # https://dl.k8s.io/release/stable.txt

# Redes do projeto
rede_cidr_hosts: "172.24.0.0/24"
rede_cidr_pods: "172.24.4.0/22"
rede_cidr_services: "172.24.8.0/22"

# Primeiros IPs das redes
primeiro_ip_hosts: "{{ rede_cidr_hosts | ansible.netcommon.ipaddr('1') }}"
primeiro_ip_pods: "{{ rede_cidr_pods | ansible.netcommon.ipaddr('1') }}"
primeiro_ip_services: "{{ rede_cidr_services | ansible.netcommon.ipaddr('1') }}"

# Portas usadas no projeto
porta_etcd_https: 2379
porta_etcd_peers: 2380
porta_etcd_metricas: 2381
porta_kubeapiserver: 6443

########################################
### Configurações para a role 02-pki ###
########################################

# Pasta onde ficam os artefatos dos certificados
pki_pasta_base: "{{ pasta_artefatos }}/pki"

# Pastas para os CAs e certificados:
pki_pastas:
  ca: "{{ pki_pasta_base }}/CAs"
  etcd: "{{ pki_pasta_base }}/etcd"
  k8s: "{{ pki_pasta_base }}/k8s"

# Configuração que decide se os certificados serão regerados
pki_regerar_certs: true

# Configurações padrão para todos os certificados
pki_subject_padrao: &pki_subject_padrao
  C: BR
  ST: Minas Gerais
  L: Uberlandia
  O: K8s-in-a-Box

# Configurações para o Root CA
pki_root_ca:
  path_chave: "{{ pki_pastas.ca }}/ca-root-chave.pem"
  path_csr: "{{ pki_pastas.ca }}/ca-root.csr"
  path_cert: "{{ pki_pastas.ca }}/ca-root-cert.pem"
  subject:
    <<: *pki_subject_padrao
    OU: Autoridade Raiz
    CN: K8s-in-a-Box Root CA
  basic_constraints:
    - "CA:TRUE"
    - "pathlen:1"
  basic_constraints_critical: true
  key_usage:
    - keyCertSign
    - cRLSign
  key_usage_critical: true
  usar_cn_como_san: false

# Configurações para os CAs intermediários
pki_cas_intermediarios:
  etcd:
    path_chave: "{{ pki_pastas.ca }}/ca-etcd-chave.pem"
    path_csr: "{{ pki_pastas.ca }}/ca-etcd.csr"
    path_cert: "{{ pki_pastas.ca }}/ca-etcd-cert.pem"
    ca_pai: "{{ pki_root_ca }}"
    subject:
      <<: *pki_subject_padrao
      OU: Autoridade Intermediaria Etcd
      CN: K8s-in-a-Box Etcd CA
    basic_constraints:
        - "CA:TRUE"
        - "pathlen:0"
    basic_constraints_critical: true
    key_usage:
      - keyCertSign
      - cRLSign
    key_usage_critical: true
    usar_cn_como_san: false
  
  kubernetes:
    path_chave: "{{ pki_pastas.ca }}/ca-k8s-chave.pem"
    path_csr: "{{ pki_pastas.ca }}/ca-k8s.csr"
    path_cert: "{{ pki_pastas.ca }}/ca-k8s-cert.pem"
    ca_pai: "{{ pki_root_ca }}"
    subject:
      <<: *pki_subject_padrao
      OU: Autoridade Intermediaria Kubernetes
      CN: K8s-in-a-Box Kubernetes CA
    basic_constraints:
        - "CA:TRUE"
        - "pathlen:0"
    basic_constraints_critical: true
    key_usage:
      - keyCertSign
      - cRLSign
    key_usage_critical: true
    usar_cn_como_san: false

pki_certificados:
  etcd-apiserver-cliente:
    path_chave: "{{ pki_pastas.etcd }}/etcd-apiserver-cliente-chave.pem"
    path_csr: "{{ pki_pastas.etcd }}/etcd-apiserver-cliente.csr"
    path_cert: "{{ pki_pastas.etcd }}/etcd-apiserver-cliente-cert.pem"
    ca_pai: "{{ pki_cas_intermediarios['etcd'] }}"
    subject:
      <<: *pki_subject_padrao
      OU: Cliente Etcd para API Server
      CN: etcd-apiserver-cliente
    key_usage:
      - digitalSignature
      - keyAgreement
    key_usage_critical: true
    extended_key_usage:
      - clientAuth
    extended_key_usage_critical: true
    san: "{{ 
      [
        'IP:127.0.0.1',
        'DNS:localhost'
      ]
      + (groups['managers']
         | map('extract', hostvars, 'ansible_host') 
         | map('regex_replace', '^(.*)$', 'IP:\\1') 
         | list)
      + (groups['managers']
         | map('regex_replace', '^(.*)$', 'DNS:\\1.k8sbox.local') 
         | list)
    }}"